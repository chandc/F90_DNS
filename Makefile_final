# ============================================================================
# MAKEFILE FOR COMPLETE NAVIER-STOKES CHANNEL FLOW SOLVER WITH FFTW
# ============================================================================

# Compiler settings
FC = gfortran
FFLAGS = -O3 -fdefault-real-8 -fdefault-double-8 -fopenmp $(FFTW_INCLUDE)
DEBUG_FFLAGS = -g -O0 -fdefault-real-8 -fdefault-double-8 -fbounds-check -fbacktrace -fopenmp $(FFTW_INCLUDE)

# FFTW libraries (macOS Homebrew paths)
FFTW_INCLUDE = -I/opt/homebrew/include
FFTW_LIBDIR = -L/opt/homebrew/lib
FFTW_LIBS = $(FFTW_LIBDIR) -lfftw3 -lfftw3_threads -lm

# Source files
LGL_MODULE = lgl_module.f90
FFT_MODULE = fft_module.f90
MAIN_SOURCE = channel_flow_final.f90

# Object files
LGL_OBJ = lgl_module.o
FFT_OBJ = fft_module.o
MAIN_OBJ = channel_flow_final.o

# Executable name
EXEC = channel_flow_final

# Module files
MOD_FILES = lgl_module.mod fft_module.mod

# Default target
all: $(EXEC)

# Build executable
$(EXEC): $(LGL_OBJ) $(FFT_OBJ) $(MAIN_OBJ)
	$(FC) $(FFLAGS) -o $@ $(LGL_OBJ) $(FFT_OBJ) $(MAIN_OBJ) $(FFTW_LIBS)
	@echo "============================================"
	@echo "  Build completed successfully!"
	@echo "  Run with: ./$(EXEC)"
	@echo "============================================"

# Build LGL module
$(LGL_OBJ): $(LGL_MODULE)
	$(FC) $(FFLAGS) -c $<

# Build FFT module
$(FFT_OBJ): $(FFT_MODULE)
	$(FC) $(FFLAGS) -c $<

# Build main program (depends on modules)
$(MAIN_OBJ): $(MAIN_SOURCE) $(LGL_OBJ) $(FFT_OBJ)
	$(FC) $(FFLAGS) -c $<

# Debug build
debug: FFLAGS = $(DEBUG_FFLAGS)
debug: clean $(EXEC)

# Test build (quick compilation check)
test: clean
	@echo "Testing compilation..."
	$(MAKE) $(EXEC)
	@echo "Compilation test passed!"

# Clean build artifacts
clean:
	rm -f $(LGL_OBJ) $(FFT_OBJ) $(MAIN_OBJ) $(MOD_FILES)
	@echo "Build artifacts cleaned"

# Full clean (including executable)
distclean: clean
	rm -f $(EXEC)
	rm -f *.dat
	@echo "Full clean completed"

# Show compiler and FFTW information
info:
	@echo "============================================"
	@echo "  Build Configuration"
	@echo "============================================"
	@echo "Compiler: $(FC)"
	@echo "Flags: $(FFLAGS)"
	@echo "FFTW Libraries: $(FFTW_LIBS)"
	@echo "Modules: $(LGL_MODULE) $(FFT_MODULE)"
	@echo "Main Source: $(MAIN_SOURCE)"
	@echo "Executable: $(EXEC)"
	@echo "============================================"

# Help
help:
	@echo "Available targets:"
	@echo "  all       - Build the complete solver (default)"
	@echo "  debug     - Build with debug flags"
	@echo "  test      - Test compilation"
	@echo "  clean     - Remove object files and modules"
	@echo "  distclean - Remove all generated files"
	@echo "  info      - Show build configuration"
	@echo "  help      - Show this help message"

.PHONY: all debug test clean distclean info help
