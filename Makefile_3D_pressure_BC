# Makefile for 3D DNS with Enhanced Optimization (Phase 1)
# Updated to use native FFTW3 real-to-complex transforms with performance optimizations

F90 = gfortran
FFLAGS = -O3 -ffast-math -funroll-loops -finline-functions \
         -ftree-vectorize -fopenmp -g
LIBS = -lfftw3_threads -lfftw3 -llapack -lblas -lm -lgomp

# Include paths
INCLUDES = -I/opt/homebrew/include
# Library paths
LIBPATHS = -L/opt/homebrew/lib

# Source files (updated to use FFTW3)
SRCS = lgl_module.f90 fftw3_dns_module.f90 perturbation_module.f90 perturbation_analytical_simple.f90 DNS_pressure_BC_3D.f90
# Object files
OBJS = $(SRCS:.f90=.o)

# Target executable
TARGET = dns_3d_pressure_bc

# Phony targets
.PHONY: all clean run

# Default target
all: $(TARGET)

# Link the executable
# '$^' automatically uses the list of prerequisites (the object files)
$(TARGET): $(OBJS)
	$(F90) $(FFLAGS) $(LIBPATHS) -o $@ $^ $(LIBS)

# Generic compilation rule for .f90 files
# This rule will be used for any .o target that doesn't have an explicit rule.
%.o: %.f90
	$(F90) $(FFLAGS) $(INCLUDES) -c $< -o $@

# Dependencies to enforce correct compilation order (updated for FFTW3)
# By listing the .o files as prerequisites, we ensure the corresponding
# .mod files are created before they are needed.
DNS_pressure_BC_3D.o: fftw3_dns_module.o lgl_module.o perturbation_module.o perturbation_analytical_simple.o
perturbation_module.o: lgl_module.o fftw3_dns_module.o
perturbation_analytical_simple.o: # No dependencies (standalone analytical module)
fftw3_dns_module.o: # No dependencies (standalone FFTW3 module)

# Clean
clean:
	rm -f *.o *.mod $(TARGET)

# Run
run: $(TARGET)
	./$(TARGET)
