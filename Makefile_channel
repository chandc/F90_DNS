# =============================================================================
# Makefile for 3D Navier-Stokes Channel Flow Solver (F90)
# =============================================================================

# Compiler and flags
FC = gfortran
FFLAGS = -O3 -fdefault-real-8 -fdefault-double-8 -fopenmp -Wall -Wextra
LDFLAGS = -lfftw3 -lfftw3_omp -llapack -lblas -lm -fopenmp

# Source files
SOURCES = lgl_module.f90 fft_module.f90 base_code.f90
OBJECTS = $(SOURCES:.f90=.o)
TARGET = channel_flow_solver

# Module dependencies
base_code.o: lgl_module.o fft_module.o

# Default target
all: $(TARGET)

$(TARGET): $(OBJECTS)
	$(FC) $(FFLAGS) -o $@ $^ $(LDFLAGS)

%.o: %.f90
	$(FC) $(FFLAGS) -c $<

clean:
	rm -f *.o *.mod $(TARGET)

# Create sample input file
input.dat:
	@echo "Creating sample input.dat..."
	@echo "&inputs" > input.dat
	@echo " istart=0, dt=0.01, nsteps=100, nwrt=10, iform=0, iles=0" >> input.dat
	@echo "/" >> input.dat
	@echo "&params" >> input.dat
	@echo " xlen=6.28318, ylen=1.0, re=180.0, ta=0.0, ybar=1.0," >> input.dat
	@echo " cgstol=1.0e-4, cs=0.1, u00=0.0, wavlen=1.0" >> input.dat
	@echo "/" >> input.dat

# Test compilation
test: $(TARGET) input.dat
	@echo "Testing compilation..."
	./$(TARGET)

# Development build with debug flags
debug: FFLAGS = -g -fdefault-real-8 -fdefault-double-8 -fopenmp -Wall -Wextra -fcheck=all
debug: $(TARGET)

.PHONY: all clean test debug
