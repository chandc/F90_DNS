# Makefile for Phase 2.2 DNS Integration Test
# Tests integration of solenoidal perturbations with DNS solver

# Compiler and flags
FC = gfortran
FFLAGS = -O3 -fdefault-real-8 -fdefault-double-8 -march=native -funroll-loops
INCLUDES = -I/opt/homebrew/include
LIBS = -L/opt/homebrew/lib -lfftw3 -lfftw3_threads -llapack -lblas -lm

# Object files
OBJS = lgl_module.o fftw3_dns_module.o perturbation_module.o test_perturbation_phase2_2.o

# Target
TARGET = test_perturbation_phase2_2

# Default target
all: $(TARGET)

# Main target
$(TARGET): $(OBJS)
	$(FC) $(FFLAGS) -o $@ $(OBJS) $(LIBS)

# Object file rules
lgl_module.o: lgl_module.f90
	$(FC) $(FFLAGS) -c $<

fftw3_dns_module.o: fftw3_dns_module.f90
	$(FC) $(FFLAGS) $(INCLUDES) -c $<

perturbation_module.o: perturbation_module.f90 lgl_module.o fftw3_dns_module.o
	$(FC) $(FFLAGS) $(INCLUDES) -c $<

test_perturbation_phase2_2.o: test_perturbation_phase2_2.f90 lgl_module.o fftw3_dns_module.o perturbation_module.o
	$(FC) $(FFLAGS) $(INCLUDES) -c $<

# Run test
test: $(TARGET)
	@echo "=========================================="
	@echo "ðŸ§ª Running Phase 2.2 DNS Integration Test"
	@echo "=========================================="
	./$(TARGET)

# Clean
clean:
	rm -f *.o *.mod $(TARGET)

.PHONY: all test clean
